<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Database Course Homework</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <header>
        <nav>
            <h1 class="logo">Database-doctors</h1>
            <ul class="nav-links">
                <li><a href="#">Home</a></li>
                <li><a href="#">Search</a></li>
                <li><a href="#">Appointments</a></li>
                <li><a href="#">Profile</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="search">
            <h2>Search for Appointments</h2>
            <form>
                <label for="speciality">Speciality:</label>
                <select id="speciality" name="speciality">
                    <!-- Options will be added dynamically -->
                </select>
                <label for="date">Date:</label>
                <input type="date" id="date" name="date" />
                <label for="city">City:</label>
                <select id="city" name="city" placeholder="Select a swedish city"></select>
                <button type="submit">Search</button>
            </form>
            <div id="result">
                <!-- Appointment results will be displayed here -->
            </div>
        </section>

        <section id="user-appointments">
            <h2>Your Appointments</h2>
            <div id="user-appointments-list">
                <!-- User's booked appointments will be displayed here -->
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2023 Database Course Homework</p>
    </footer>
</body>

<script type="module">
    // Define an array of allowed cities in Sweden
    const allowedPlaces = [
        "Stockholm",
        "Gothenburg",
        "Malmö",
        "Uppsala",
        "Västerås",
        "Örebro",
        "Linköping",
        "Helsingborg",
        "Jönköping",
        "Norrköping",
        "Lund",
        "Umeå",
    ];
    // Add the options to the select element for city
    const selectCity = document.getElementById("city");
    for (let i = 0; i < allowedPlaces.length; i++) {
        const option = document.createElement("option");
        option.value = allowedPlaces[i];
        option.text = allowedPlaces[i];
        selectCity.appendChild(option);
    }

    const specialities = [
        "All Specialities",
        "Cardiology",
        "Dentistry",
        "Dermatology",
        "Orthopedics",
        "Neurology",
        "Pediatrics",
        "Oncology",
        "Psychiatry",
        "Radiology",
        "Ophthalmology",
        "Gynecology",
    ];

    // Add the options to the select element
    const select = document.getElementById("speciality");
    for (let i = 0; i < specialities.length; i++) {
        const option = document.createElement("option");
        option.value = specialities[i];
        option.text = specialities[i];
        select.appendChild(option);
    }

    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
    } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";
    import {
        getFirestore,
        getDocs,
        collection,
        where,
        query
    } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDeiRIFp3pz2fNxMlGCsTc-NA7GviQghZU",
        authDomain: "database-project-bd7e8.firebaseapp.com",
        projectId: "database-project-bd7e8",
        storageBucket: "database-project-bd7e8.appspot.com",
        messagingSenderId: "771888139690",
        appId: "1:771888139690:web:6b1e5ee383ec06df976fd3",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // Initialize Firebase Authentication
    const auth = getAuth(app);

    // Initialize Firestore
    const db = getFirestore(app);

    // Handle Account Status
    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location = 'index.html'; // If User is not logged in, redirect to login page
        }
    });

    const user = auth.currentUser;

    // Add a welcome message
    const welcomeMessage = document.createElement('h2');
    welcomeMessage.textContent = `Welcome ${user}`;
    const main = document.querySelector('main');
    main.insertBefore(welcomeMessage, main.firstChild);

    // Add a sign out button

    const signOutButton = document.createElement('button');
    signOutButton.textContent = 'Sign Out';
    signOutButton.addEventListener('click', signOutUser);
    main.insertBefore(signOutButton, main.firstChild);

    function signOutUser() {
        signOut(auth).then(() => {
            console.log("Sign out succesful.");
        }).catch((error) => {
            console.log("An error happened during sign out.");
        });
    }

    //Function to display
    function displaySearchResults(querySnapshot) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = ''; // Clear previous results

        if (querySnapshot.empty) {
            resultDiv.textContent = 'No doctors found.';
            return;
        }

        querySnapshot.forEach((doc) => {
            const doctorData = doc.data();

            // Create elements to display doctor information (e.g., name, speciality, etc.)
            const doctorCard = document.createElement('div');
            doctorCard.classList.add('doctor-card');
            // Add doctor information to the card

            const doctorName = document.createElement('h3');
            doctorName.textContent = doctorData.name;

            const doctorSpeciality = document.createElement('p');
            doctorSpeciality.textContent = `Speciality: ${doctorData.speciality}`;

            const doctorCity = document.createElement('p');
            doctorCity.textContent = `City: ${doctorData.city}`;

            // You can add more elements to display other doctor information as needed

            // Append the elements to the card
            doctorCard.appendChild(doctorName);
            doctorCard.appendChild(doctorSpeciality);
            doctorCard.appendChild(doctorCity);

            // Append the card to the appointmentsDiv
            resultDiv.appendChild(doctorCard);
        });
    }

    // Get the doctors database
    const doctorsDB = collection(db, 'doctors');
    const searchForm = document.querySelector('form');
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // Prevent the default form submission behavior

        // Collect user input
        const speciality = document.getElementById('speciality').value;
        const date = document.getElementById('date').value;
        const city = document.getElementById('city').value;

        // Query the Firebase database based on user input
        let answer = query(doctorsDB);

        if (speciality !== 'All Specialities') {
            answer = query(answer, where('speciality', '==', speciality));
        }

        //TODO, gérer la date
        //if (date !== '') {
            //answer = ;
        //}

        if (city !== '') {
            answer = query(answer, where('city', '==', city));
        }
        // Execute the query
        const querySnapshot = await getDocs(answer);

        // Display the search results
        displaySearchResults(querySnapshot);
    });
</script>

</html>